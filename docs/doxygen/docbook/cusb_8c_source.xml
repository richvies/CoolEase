<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="_cusb_8c_source" xml:lang="en-US">
<title>cusb.c</title>
<indexterm><primary>hub/src/cusb.c</primary></indexterm>
<programlisting>00001 
00011 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00012 <emphasis role="comment">//&#32;Includes</emphasis>
00013 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00014 
00015 <emphasis role="preprocessor">#include&#32;&lt;<link linkend="_cusb_8h">hub/cusb.h</link>&gt;</emphasis>
00016 
00017 <emphasis role="preprocessor">#include&#32;&lt;stddef.h&gt;</emphasis>
00018 
00019 <emphasis role="preprocessor">#include&#32;&lt;libopencm3/stm32/syscfg.h&gt;</emphasis>
00020 <emphasis role="preprocessor">#include&#32;&lt;libopencm3/stm32/rcc.h&gt;</emphasis>
00021 <emphasis role="preprocessor">#include&#32;&lt;libopencm3/stm32/flash.h&gt;</emphasis>
00022 <emphasis role="preprocessor">#include&#32;&lt;libopencm3/stm32/crs.h&gt;</emphasis>
00023 <emphasis role="preprocessor">#include&#32;&lt;libopencm3/cm3/nvic.h&gt;</emphasis>
00024 
00025 <emphasis role="preprocessor">#include&#32;&lt;libopencm3/usb/usbd.h&gt;</emphasis>
00026 <emphasis role="preprocessor">#include&#32;&quot;../../libopencm3/lib/usb/usb_private.h&quot;</emphasis>
00027 <emphasis role="preprocessor">#include&#32;&lt;libopencm3/stm32/st_usbfs.h&gt;</emphasis>
00028 <emphasis role="preprocessor">#include&#32;&lt;libopencm3/usb/hid.h&gt;</emphasis>
00029 
00034 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00035 <emphasis role="comment">//&#32;USB&#32;Configuration&#32;&amp;&#32;Descriptors</emphasis>
00036 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00037 
<anchor xml:id="_cusb_8c_source_1l00052"/><link linkend="_group___c_u_s_b___c_f_g_1gade943db11170b477241c1a88478ad911">00052</link> <emphasis role="keyword">enum</emphasis>&#32;<link linkend="_group___c_u_s_b___c_f_g_1gade943db11170b477241c1a88478ad911">dev_interfaces</link>
00053 {
<anchor xml:id="_cusb_8c_source_1l00054"/><link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911a204042907dfd3f14df88d44ca34c9bf5">00054</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911a204042907dfd3f14df88d44ca34c9bf5">INTERFACE_HID</link>&#32;=&#32;0,
00055 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;next&#32;two&#32;must&#32;be&#32;consecutive&#32;since&#32;they&#32;are&#32;used&#32;in&#32;an&#32;Interface</emphasis>
00056 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Assication&#32;below.&#32;If&#32;the&#32;order&#32;is&#32;changed&#32;then&#32;the&#32;IAD&#32;must&#32;be&#32;changed&#32;as</emphasis>
00057 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;well</emphasis>
<anchor xml:id="_cusb_8c_source_1l00058"/><link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911ae06ae546abc0d38b7996d28d7b81afc0">00058</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911ae06ae546abc0d38b7996d28d7b81afc0">INTERFACE_CDC_COMM</link>&#32;=&#32;1,
<anchor xml:id="_cusb_8c_source_1l00059"/><link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911a6cd1255b80eacfa5017757c3cba61be0">00059</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911a6cd1255b80eacfa5017757c3cba61be0">INTERFACE_CDC_DATA</link>&#32;=&#32;2,
<anchor xml:id="_cusb_8c_source_1l00060"/><link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911ae38d5030fdcdb4a30b5a7c225f738de2">00060</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911ae38d5030fdcdb4a30b5a7c225f738de2">INTERFACE_KEYBOARD_HID</link>&#32;=&#32;3,
<anchor xml:id="_cusb_8c_source_1l00061"/><link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911a6c498f5b0c6a28de865172df9f4028b6">00061</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911a6c498f5b0c6a28de865172df9f4028b6">INTERFACE_COUNT</link>&#32;=&#32;1,
00062 };
00063 
<anchor xml:id="_cusb_8c_source_1l00065"/><link linkend="_group___c_u_s_b___c_f_g_1ga8d04a14f4c991504e1ee2df8b5e6f05c">00065</link> <emphasis role="keyword">enum</emphasis>&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga8d04a14f4c991504e1ee2df8b5e6f05c">dev_endpoints</link>
00066 {
<anchor xml:id="_cusb_8c_source_1l00067"/><link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cac4a444971bf8e52ed478f89a9aea2f6d">00067</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cac4a444971bf8e52ed478f89a9aea2f6d">ENDPOINT_HID_IN</link>&#32;=&#32;0x81,
<anchor xml:id="_cusb_8c_source_1l00068"/><link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cab6fa532c71274a0aa3a49297153fad04">00068</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cab6fa532c71274a0aa3a49297153fad04">ENDPOINT_HID_OUT</link>&#32;=&#32;0x01,
<anchor xml:id="_cusb_8c_source_1l00069"/><link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05ca322fcbffd8676c20ed0b2ed1e76ee6da">00069</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05ca322fcbffd8676c20ed0b2ed1e76ee6da">ENDPOINT_CDC_COMM_IN</link>&#32;=&#32;0x83,
<anchor xml:id="_cusb_8c_source_1l00070"/><link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cadfde3aef860817b6e38f2928484b3226">00070</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cadfde3aef860817b6e38f2928484b3226">ENDPOINT_CDC_DATA_IN</link>&#32;=&#32;0x82,
<anchor xml:id="_cusb_8c_source_1l00071"/><link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cae7dadfb0336e7b90c79fcb7d6158a52f">00071</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cae7dadfb0336e7b90c79fcb7d6158a52f">ENDPOINT_CDC_DATA_OUT</link>&#32;=&#32;0x02,
<anchor xml:id="_cusb_8c_source_1l00072"/><link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cab0db9905c5948515d9bb6c56a836aa67">00072</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cab0db9905c5948515d9bb6c56a836aa67">ENDPOINT_KEYBOARD_HID_IN</link>&#32;=&#32;0x84,
00073 };
00074 
<anchor xml:id="_cusb_8c_source_1l00075"/><link linkend="_group___c_u_s_b___c_f_g_1ga3398c7225386f04c72fd9025fcb44734">00075</link> <emphasis role="preprocessor">#define&#32;USB_VID&#32;0x0483&#32;</emphasis>
<anchor xml:id="_cusb_8c_source_1l00076"/><link linkend="_group___c_u_s_b___c_f_g_1ga989c980e0b99f803f7ce0ca224cdb733">00076</link> <emphasis role="preprocessor">#define&#32;USB_PID&#32;0x5750&#32;</emphasis>
00077 <emphasis role="preprocessor"></emphasis>
00078 
<anchor xml:id="_cusb_8c_source_1l00079"/><link linkend="_group___c_u_s_b___c_f_g_1ga8e8903d0c7276e7295ce8a9aaea727b4">00079</link> <emphasis role="keyword">enum</emphasis>&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga8e8903d0c7276e7295ce8a9aaea727b4">usb_strings_index</link>
00080 {
<anchor xml:id="_cusb_8c_source_1l00081"/><link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4adc3ba5b9e0450cfc1586c5e96138e8fc">00081</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4adc3ba5b9e0450cfc1586c5e96138e8fc">USB_LANGID_IDX</link>&#32;=&#32;0,
<anchor xml:id="_cusb_8c_source_1l00082"/><link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a896869157e00662b55740010582e3bae">00082</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a896869157e00662b55740010582e3bae">USB_MANUFACTURER_IDX</link>,
<anchor xml:id="_cusb_8c_source_1l00083"/><link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a28c69675cc67c534eb4ee5fcad847220">00083</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a28c69675cc67c534eb4ee5fcad847220">USB_PRODUCT_IDX</link>,
<anchor xml:id="_cusb_8c_source_1l00084"/><link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4ac8955a3859ce8b787eed5575ad8417c4">00084</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4ac8955a3859ce8b787eed5575ad8417c4">USB_SERIAL_IDX</link>,
<anchor xml:id="_cusb_8c_source_1l00085"/><link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a4424c4941324bf6b1d66433316169a9e">00085</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a4424c4941324bf6b1d66433316169a9e">USB_CONFIGURATION_IDX</link>,
<anchor xml:id="_cusb_8c_source_1l00086"/><link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a3b345bc3edfee8aa2613f949a2db88f5">00086</link> &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a3b345bc3edfee8aa2613f949a2db88f5">USB_INTERFACE_IDX</link>,
00087 };
00088 
<anchor xml:id="_cusb_8c_source_1l00090"/><link linkend="_group___c_u_s_b___c_f_g_1ga2c37a11433a81e9f3e364d952a65ce5a">00090</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keywordtype">char</emphasis>&#32;*<emphasis role="keyword">const</emphasis>&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga2c37a11433a81e9f3e364d952a65ce5a">usb_strings</link>[]&#32;=
00091 {
00092 &#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;CoolEase&quot;</emphasis>,
00093 &#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;CoolEase&#32;Hub&quot;</emphasis>,
00094 &#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;12345&quot;</emphasis>,
00095 &#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;Custom&#32;HID&#32;Config&quot;</emphasis>
00096 &#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;Custom&#32;HID&#32;Interface&quot;</emphasis>,
00097 };
00098 
00100 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keyword">struct&#32;</emphasis>usb_device_descriptor&#32;<link linkend="_group___c_u_s_b___c_f_g_1gaa168c0763ac7b2a074fba1297b1733b3">dev_desc</link>&#32;=
00101 {
00102 &#32;&#32;&#32;&#32;.bLength&#32;=&#32;USB_DT_DEVICE_SIZE,
00103 &#32;&#32;&#32;&#32;.bDescriptorType&#32;=&#32;USB_DT_DEVICE,
00104 &#32;&#32;&#32;&#32;.bcdUSB&#32;=&#32;0x0200,
00105 &#32;&#32;&#32;&#32;.bDeviceClass&#32;=&#32;0x00,
00106 &#32;&#32;&#32;&#32;.bDeviceSubClass&#32;=&#32;0x00,
00107 &#32;&#32;&#32;&#32;.bDeviceProtocol&#32;=&#32;0x00,
00108 &#32;&#32;&#32;&#32;.bMaxPacketSize0&#32;=&#32;64,
00109 &#32;&#32;&#32;&#32;.idVendor&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga3398c7225386f04c72fd9025fcb44734">USB_VID</link>,
00110 &#32;&#32;&#32;&#32;.idProduct&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga989c980e0b99f803f7ce0ca224cdb733">USB_PID</link>,
00111 &#32;&#32;&#32;&#32;.bcdDevice&#32;=&#32;0x0200,
00112 &#32;&#32;&#32;&#32;.iManufacturer&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a896869157e00662b55740010582e3bae">USB_MANUFACTURER_IDX</link>,
00113 &#32;&#32;&#32;&#32;.iProduct&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a28c69675cc67c534eb4ee5fcad847220">USB_PRODUCT_IDX</link>,
00114 &#32;&#32;&#32;&#32;.iSerialNumber&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4ac8955a3859ce8b787eed5575ad8417c4">USB_SERIAL_IDX</link>,
00115 &#32;&#32;&#32;&#32;.bNumConfigurations&#32;=&#32;1
00116 };
00117 
00119 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keyword">struct&#32;</emphasis>usb_endpoint_descriptor&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga924c026f7b247b10ffd34e57fc9453d4">hid_interface_endpoints</link>[]&#32;=
00120 {
00121 &#32;&#32;&#32;&#32;{
00122 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;size&#32;of&#32;the&#32;endpoint&#32;descriptor&#32;in&#32;bytes:&#32;7.</emphasis>
00123 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bLength&#32;=&#32;USB_DT_ENDPOINT_SIZE,
00124 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;A&#32;value&#32;of&#32;5&#32;indicates&#32;that&#32;this&#32;describes&#32;an&#32;endpoint.</emphasis>
00125 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bDescriptorType&#32;=&#32;USB_DT_ENDPOINT,
00126 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bit&#32;7&#32;indicates&#32;direction:&#32;0&#32;for&#32;OUT&#32;(to&#32;device)&#32;1&#32;for&#32;IN&#32;(to&#32;host).</emphasis>
00127 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bits&#32;6-4&#32;must&#32;be&#32;set&#32;to&#32;0.</emphasis>
00128 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bits&#32;3-0&#32;indicate&#32;the&#32;endpoint&#32;number&#32;(zero&#32;is&#32;not&#32;allowed).</emphasis>
00129 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Here&#32;we&#32;define&#32;the&#32;IN&#32;side&#32;of&#32;endpoint&#32;1.</emphasis>
00130 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bEndpointAddress&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cac4a444971bf8e52ed478f89a9aea2f6d">ENDPOINT_HID_IN</link>,
00131 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bit&#32;7-2&#32;are&#32;only&#32;used&#32;in&#32;Isochronous&#32;mode,&#32;otherwise&#32;they&#32;should&#32;be</emphasis>
00132 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;0.</emphasis>
00133 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bit&#32;1-0:&#32;Indicates&#32;the&#32;mode&#32;of&#32;this&#32;endpoint.</emphasis>
00134 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;00:&#32;Control</emphasis>
00135 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;01:&#32;Isochronous</emphasis>
00136 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;10:&#32;Bulk</emphasis>
00137 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;11:&#32;Interrupt</emphasis>
00138 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Here&#32;we&apos;re&#32;using&#32;interrupt.</emphasis>
00139 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bmAttributes&#32;=&#32;USB_ENDPOINT_ATTR_INTERRUPT,
00140 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Maximum&#32;packet&#32;size.</emphasis>
00141 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.wMaxPacketSize&#32;=&#32;64,
00142 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;frequency,&#32;in&#32;number&#32;of&#32;frames,&#32;that&#32;we&apos;re&#32;going&#32;to&#32;be&#32;sending</emphasis>
00143 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;data.&#32;Here&#32;we&apos;re&#32;saying&#32;we&apos;re&#32;going&#32;to&#32;send&#32;data&#32;every&#32;millisecond.</emphasis>
00144 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bInterval&#32;=&#32;1,
00145 &#32;&#32;&#32;&#32;},
00146 &#32;&#32;&#32;&#32;{
00147 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;size&#32;of&#32;the&#32;endpoint&#32;descriptor&#32;in&#32;bytes:&#32;7.</emphasis>
00148 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bLength&#32;=&#32;USB_DT_ENDPOINT_SIZE,
00149 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;A&#32;value&#32;of&#32;5&#32;indicates&#32;that&#32;this&#32;describes&#32;an&#32;endpoint.</emphasis>
00150 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bDescriptorType&#32;=&#32;USB_DT_ENDPOINT,
00151 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bit&#32;7&#32;indicates&#32;direction:&#32;0&#32;for&#32;OUT&#32;(to&#32;device)&#32;1&#32;for&#32;IN&#32;(to&#32;host).</emphasis>
00152 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bits&#32;6-4&#32;must&#32;be&#32;set&#32;to&#32;0.</emphasis>
00153 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bits&#32;3-0&#32;indicate&#32;the&#32;endpoint&#32;number&#32;(zero&#32;is&#32;not&#32;allowed).</emphasis>
00154 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Here&#32;we&#32;define&#32;the&#32;OUT&#32;side&#32;of&#32;endpoint&#32;1.</emphasis>
00155 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bEndpointAddress&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cab6fa532c71274a0aa3a49297153fad04">ENDPOINT_HID_OUT</link>,
00156 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bit&#32;7-2&#32;are&#32;only&#32;used&#32;in&#32;Isochronous&#32;mode,&#32;otherwise&#32;they&#32;should&#32;be</emphasis>
00157 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;0.</emphasis>
00158 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Bit&#32;1-0:&#32;Indicates&#32;the&#32;mode&#32;of&#32;this&#32;endpoint.</emphasis>
00159 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;00:&#32;Control</emphasis>
00160 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;01:&#32;Isochronous</emphasis>
00161 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;10:&#32;Bulk</emphasis>
00162 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;11:&#32;Interrupt</emphasis>
00163 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Here&#32;we&apos;re&#32;using&#32;interrupt.</emphasis>
00164 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bmAttributes&#32;=&#32;USB_ENDPOINT_ATTR_INTERRUPT,
00165 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Maximum&#32;packet&#32;size.</emphasis>
00166 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.wMaxPacketSize&#32;=&#32;64,
00167 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;frequency,&#32;in&#32;number&#32;of&#32;frames,&#32;that&#32;we&apos;re&#32;going&#32;to&#32;be&#32;sending</emphasis>
00168 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;data.&#32;Here&#32;we&apos;re&#32;saying&#32;we&apos;re&#32;going&#32;to&#32;send&#32;data&#32;every&#32;millisecond.</emphasis>
00169 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bInterval&#32;=&#32;1,
00170 &#32;&#32;&#32;&#32;}
00171 };
00172 
<anchor xml:id="_cusb_8c_source_1l00180"/><link linkend="_group___c_u_s_b___c_f_g_1ga76de0fd52b1f8961911ef2c5f5a51d1b">00180</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;uint8_t&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga3150d0aa42aafc82cadbd40100171fae">hid_report_descriptor</link>[]&#32;=
00181 {
00182 &#32;&#32;&#32;&#32;0x06,&#32;0x00,&#32;0xff,&#32;<emphasis role="comment">//&#32;USAGE_PAGE&#32;(Vendor&#32;Defined&#32;Page&#32;1)</emphasis>
00183 &#32;&#32;&#32;&#32;0x09,&#32;0x01,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;USAGE&#32;(Vendor&#32;Usage&#32;1)</emphasis>
00184 &#32;&#32;&#32;&#32;0xa1,&#32;0x01,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;COLLECTION&#32;(Application)</emphasis>
00185 &#32;&#32;&#32;&#32;0x09,&#32;0x01,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;USAGE&#32;(Vendor&#32;Usage&#32;1)</emphasis>
00186 &#32;&#32;&#32;&#32;0x15,&#32;0x00,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;LOGICAL_MINIMUM&#32;(0)</emphasis>
00187 &#32;&#32;&#32;&#32;0x26,&#32;0xff,&#32;0x00,&#32;<emphasis role="comment">//&#32;&#32;&#32;LOGICAL_MAXIMUM&#32;(255)</emphasis>
00188 &#32;&#32;&#32;&#32;0x75,&#32;0x08,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;REPORT_SIZE&#32;(8)</emphasis>
00189 &#32;&#32;&#32;&#32;0x95,&#32;0x40,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;REPORT_COUNT&#32;(64)</emphasis>
00190 &#32;&#32;&#32;&#32;0x81,&#32;0x02,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;INPUT&#32;(Data,Var,Abs)</emphasis>
00191 &#32;&#32;&#32;&#32;0x09,&#32;0x01,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;USAGE&#32;(Vendor&#32;Usage&#32;1)</emphasis>
00192 &#32;&#32;&#32;&#32;0x91,&#32;0x02,&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;OUTPUT&#32;(Data,Var,Abs)</emphasis>
00193 &#32;&#32;&#32;&#32;0xc0&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;END_COLLECTION</emphasis>
00194 };
00195 
<anchor xml:id="_cusb_8c_source_1l00197"/><link linkend="_structhid__function__descriptor">00197</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keyword">struct&#32;</emphasis><link linkend="_structhid__function__descriptor">hid_function_descriptor</link>
00198 {
00199 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>usb_hid_descriptor&#32;<link linkend="_structhid__function__descriptor_1a21e8b11a4b3fdf88762491887f5a27fe">hid_descriptor</link>;
00200 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>
00201 &#32;&#32;&#32;&#32;{
<anchor xml:id="_cusb_8c_source_1l00202"/><link linkend="_structhid__function__descriptor_1ab170f72aaf50751c2950dfaec3863ec4">00202</link> &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint8_t&#32;<link linkend="_structhid__function__descriptor_1ab170f72aaf50751c2950dfaec3863ec4">bReportDescriptorType</link>;
<anchor xml:id="_cusb_8c_source_1l00203"/><link linkend="_cusb_8c_1aaac39c31cd472c2b7e766f70f43e97b4">00203</link> &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint16_t&#32;<link linkend="_structhid__function__descriptor_1a377305b02e8da0f0d3b1492b6c7b20a4">wDescriptorLength</link>;
00204 &#32;&#32;&#32;&#32;}&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga257274706fbffd56ad7d5128a11b0096">__attribute__</link>((packed))&#32;hid_report;
00205 }&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga257274706fbffd56ad7d5128a11b0096">__attribute__</link>((packed))&#32;hid_function&#32;=
00207 {
00208 &#32;&#32;&#32;&#32;.<link linkend="_structhid__function__descriptor_1a21e8b11a4b3fdf88762491887f5a27fe">hid_descriptor</link>&#32;=
<anchor xml:id="_cusb_8c_source_1l00209"/><link linkend="_cusb_8c_1a96e3f5ba4a7a1c8bb1b8fca4d4ded8e8">00209</link> &#32;&#32;&#32;&#32;{
<anchor xml:id="_cusb_8c_source_1l00210"/><link linkend="_cusb_8c_1a55bf7164e75ed7bce74dfae2c2680992">00210</link> &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;size&#32;of&#32;this&#32;header&#32;in&#32;bytes:&#32;9.</emphasis>
00211 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bLength&#32;=&#32;<emphasis role="keyword">sizeof</emphasis>(hid_function),
00212 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;type&#32;of&#32;this&#32;descriptor.&#32;HID&#32;is&#32;indicated&#32;by&#32;the&#32;value&#32;33.</emphasis>
00213 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bDescriptorType&#32;=&#32;USB_DT_HID,
00214 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;version&#32;of&#32;the&#32;HID&#32;spec&#32;used&#32;in&#32;binary&#32;coded&#32;&#32;decimal.&#32;We&#32;are</emphasis>
00215 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;using&#32;version&#32;1.11.</emphasis>
00216 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bcdHID&#32;=&#32;0x0111,
00217 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Some&#32;HID&#32;devices,&#32;like&#32;keyboards,&#32;can&#32;specify&#32;different&#32;country</emphasis>
00218 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;codes.&#32;A&#32;value&#32;of&#32;zero&#32;means&#32;not&#32;localized.</emphasis>
00219 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bCountryCode&#32;=&#32;0,
00220 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;number&#32;of&#32;descriptors&#32;that&#32;follow.&#32;This&#32;must&#32;be&#32;at&#32;least&#32;one</emphasis>
00221 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;since&#32;there&#32;should&#32;be&#32;at&#32;least&#32;a&#32;report&#32;descriptor.</emphasis>
00222 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bNumDescriptors&#32;=&#32;1,
00223 &#32;&#32;&#32;&#32;},
00224 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;report&#32;descriptor.</emphasis>
00225 &#32;&#32;&#32;&#32;.hid_report&#32;=
00226 &#32;&#32;&#32;&#32;{
00227 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;type&#32;of&#32;descriptor.&#32;A&#32;value&#32;of&#32;34&#32;indicates&#32;a&#32;report.</emphasis>
00228 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.bReportDescriptorType&#32;=&#32;USB_DT_REPORT,
00229 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;size&#32;of&#32;the&#32;descriptor&#32;defined&#32;above.</emphasis>
00230 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.wDescriptorLength&#32;=&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_group___c_u_s_b___c_f_g_1ga3150d0aa42aafc82cadbd40100171fae">hid_report_descriptor</link>),
00231 &#32;&#32;&#32;&#32;},
00232 };
00233 
00235 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keyword">struct&#32;</emphasis>usb_interface_descriptor&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga31643a6df5e6d5393f60d14c2528a8a4">hid_interface</link>&#32;=
00236 {
00237 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;size&#32;of&#32;an&#32;interface&#32;descriptor:&#32;9</emphasis>
00238 &#32;&#32;&#32;&#32;.bLength&#32;=&#32;USB_DT_INTERFACE_SIZE,
00239 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;A&#32;value&#32;of&#32;4&#32;specifies&#32;that&#32;this&#32;describes&#32;and&#32;interface.</emphasis>
00240 &#32;&#32;&#32;&#32;.bDescriptorType&#32;=&#32;USB_DT_INTERFACE,
00241 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;number&#32;for&#32;this&#32;interface.&#32;Starts&#32;counting&#32;from&#32;0.</emphasis>
00242 &#32;&#32;&#32;&#32;.bInterfaceNumber&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911a204042907dfd3f14df88d44ca34c9bf5">INTERFACE_HID</link>,
00243 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;number&#32;for&#32;this&#32;alternate&#32;setting&#32;for&#32;this&#32;interface.</emphasis>
00244 &#32;&#32;&#32;&#32;.bAlternateSetting&#32;=&#32;0,
00245 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;number&#32;of&#32;endpoints&#32;in&#32;this&#32;interface.</emphasis>
00246 &#32;&#32;&#32;&#32;.bNumEndpoints&#32;=&#32;2,
00247 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;interface&#32;class&#32;for&#32;this&#32;interface&#32;is&#32;HID,&#32;defined&#32;by&#32;3.</emphasis>
00248 &#32;&#32;&#32;&#32;.bInterfaceClass&#32;=&#32;USB_CLASS_HID,
00249 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;interface&#32;subclass&#32;for&#32;an&#32;HID&#32;device&#32;is&#32;used&#32;to&#32;indicate&#32;of&#32;this&#32;is&#32;a</emphasis>
00250 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;mouse&#32;or&#32;keyboard&#32;that&#32;is&#32;boot&#32;mode&#32;capable&#32;(1)&#32;or&#32;not&#32;(0).</emphasis>
00251 &#32;&#32;&#32;&#32;.bInterfaceSubClass&#32;=&#32;0,&#32;<emphasis role="comment">//&#32;Not&#32;a&#32;boot&#32;mode&#32;mouse&#32;or&#32;keyboard.</emphasis>
00252 &#32;&#32;&#32;&#32;.bInterfaceProtocol&#32;=&#32;0,&#32;<emphasis role="comment">//&#32;Since&#32;subclass&#32;is&#32;zero&#32;then&#32;this&#32;must&#32;be&#32;too.</emphasis>
00253 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;A&#32;string&#32;representing&#32;this&#32;interface.&#32;Zero&#32;means&#32;not&#32;provided.</emphasis>
00254 &#32;&#32;&#32;&#32;.iInterface&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a3b345bc3edfee8aa2613f949a2db88f5">USB_INTERFACE_IDX</link>,
00255 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;header&#32;ends&#32;here.</emphasis>
00256 
00257 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;A&#32;pointer&#32;to&#32;the&#32;beginning&#32;of&#32;the&#32;array&#32;of&#32;endpoints.</emphasis>
00258 &#32;&#32;&#32;&#32;.endpoint&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga924c026f7b247b10ffd34e57fc9453d4">hid_interface_endpoints</link>,
00259 
00260 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Some&#32;class&#32;types&#32;require&#32;extra&#32;data&#32;in&#32;the&#32;interface&#32;descriptor.</emphasis>
00261 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;libopencm3&#32;usb&#32;library&#32;requires&#32;that&#32;we&#32;stuff&#32;that&#32;here.</emphasis>
00262 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Pointer&#32;to&#32;the&#32;buffer&#32;holding&#32;the&#32;extra&#32;data.</emphasis>
00263 &#32;&#32;&#32;&#32;.extra&#32;=&#32;&amp;hid_function,
00264 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;length&#32;of&#32;the&#32;data&#32;at&#32;the&#32;above&#32;address.</emphasis>
00265 &#32;&#32;&#32;&#32;.extralen&#32;=&#32;<emphasis role="keyword">sizeof</emphasis>(hid_function),
00266 };
00267 
00269 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keyword">struct&#32;</emphasis>usb_interface&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga76de0fd52b1f8961911ef2c5f5a51d1b">interfaces</link>[]&#32;=
00270 {
00271 &#32;&#32;&#32;&#32;{
00272 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.num_altsetting&#32;=&#32;1,
00273 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;.altsetting&#32;=&#32;&amp;<link linkend="_group___c_u_s_b___c_f_g_1ga31643a6df5e6d5393f60d14c2528a8a4">hid_interface</link>,
00274 &#32;&#32;&#32;&#32;}
00275 };
00276 
00278 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keyword">struct&#32;</emphasis>usb_config_descriptor&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga82f3c163f54e2a1e4c606f965227af7c">cfg_desc</link>&#32;=
00279 {
00280 &#32;&#32;&#32;&#32;.bLength&#32;=&#32;USB_DT_CONFIGURATION_SIZE,
00281 &#32;&#32;&#32;&#32;.bDescriptorType&#32;=&#32;USB_DT_CONFIGURATION,
00282 &#32;&#32;&#32;&#32;.wTotalLength&#32;=&#32;0,&#32;
00283 &#32;&#32;&#32;&#32;.bNumInterfaces&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1ggade943db11170b477241c1a88478ad911a6c498f5b0c6a28de865172df9f4028b6">INTERFACE_COUNT</link>,
00284 &#32;&#32;&#32;&#32;.bConfigurationValue&#32;=&#32;1,
00285 &#32;&#32;&#32;&#32;.iConfiguration&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8e8903d0c7276e7295ce8a9aaea727b4a4424c4941324bf6b1d66433316169a9e">USB_CONFIGURATION_IDX</link>,
00286 &#32;&#32;&#32;&#32;.bmAttributes&#32;=&#32;0b10000000,&#32;
00287 &#32;&#32;&#32;&#32;.bMaxPower&#32;=&#32;200,&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
00288 &#32;&#32;&#32;&#32;.interface&#32;=&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga76de0fd52b1f8961911ef2c5f5a51d1b">interfaces</link>,
00289 };
00290 
00297 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00298 <emphasis role="comment">//&#32;Static&#32;Variables</emphasis>
00299 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00300 
00301 
00302 
00307 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">enum</emphasis>&#32;usbd_request_return_codes&#32;<link linkend="_group___c_u_s_b___i_n_t_1ga29b474a495e8084ca9f797e1fcf75eb8">hid_control_request</link>(usbd_device&#32;*dev,&#32;<emphasis role="keyword">struct</emphasis>&#32;usb_setup_data&#32;*req,&#32;uint8_t&#32;**buf,&#32;uint16_t&#32;*len,
00308 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordtype">void</emphasis>&#32;(**complete)(usbd_device&#32;*,&#32;<emphasis role="keyword">struct</emphasis>&#32;usb_setup_data&#32;*))
00309 {
00310 &#32;&#32;&#32;&#32;(void)complete;
00311 &#32;&#32;&#32;&#32;(void)dev;
00312 
00313 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;((req-&gt;bmRequestType&#32;!=&#32;0x81)&#32;||
00314 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;(req-&gt;bRequest&#32;!=&#32;USB_REQ_GET_DESCRIPTOR)&#32;||
00315 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;(req-&gt;wValue&#32;!=&#32;0x2200))
00316 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;USBD_REQ_NOTSUPP;
00317 
00318 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Handle&#32;the&#32;HID&#32;report&#32;descriptor.&#32;*/</emphasis>
00319 &#32;&#32;&#32;&#32;*buf&#32;=&#32;(uint8_t&#32;*)<link linkend="_group___c_u_s_b___c_f_g_1ga3150d0aa42aafc82cadbd40100171fae">hid_report_descriptor</link>;
00320 &#32;&#32;&#32;&#32;*len&#32;=&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_group___c_u_s_b___c_f_g_1ga3150d0aa42aafc82cadbd40100171fae">hid_report_descriptor</link>);
00321 
00322 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;USBD_REQ_HANDLED;
00323 }
00324 
<anchor xml:id="_cusb_8c_source_1l00329"/><link linkend="_group___c_u_s_b___i_n_t_1ga4cfa67ae725c5211ad5ab6e6b5e2c47a">00329</link> <emphasis role="keyword">static</emphasis>&#32;uint8_t&#32;<link linkend="_group___c_u_s_b___i_n_t_1ga4cfa67ae725c5211ad5ab6e6b5e2c47a">hid_report_buf</link>[64]&#32;=&#32;<emphasis role="stringliteral">&quot;Default&#32;Report&#32;Buffer&quot;</emphasis>;
00330 
00332 <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_group___c_u_s_b___i_n_t_1ga1bde282ff924bedfe37a99146df8b251">hid_report_callback</link>(usbd_device&#32;*<link linkend="_group___c_u_s_b___a_p_i_1ga371fec116e56a5c485a09d5dd8cd6c95">usbd_dev</link>,&#32;uint8_t&#32;ea);
<anchor xml:id="_cusb_8c_source_1l00333"/><link linkend="_group___c_u_s_b___i_n_t_1ga1bde282ff924bedfe37a99146df8b251">00333</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_group___c_u_s_b___i_n_t_1ga1bde282ff924bedfe37a99146df8b251">hid_report_callback</link>(usbd_device&#32;*<link linkend="_group___c_u_s_b___a_p_i_1ga371fec116e56a5c485a09d5dd8cd6c95">usbd_dev</link>,&#32;uint8_t&#32;ea)
00334 {
00335 &#32;&#32;&#32;&#32;usbd_ep_write_packet(<link linkend="_group___c_u_s_b___a_p_i_1ga371fec116e56a5c485a09d5dd8cd6c95">usbd_dev</link>,&#32;ea,&#32;<link linkend="_group___c_u_s_b___i_n_t_1ga4cfa67ae725c5211ad5ab6e6b5e2c47a">hid_report_buf</link>,&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_group___c_u_s_b___i_n_t_1ga4cfa67ae725c5211ad5ab6e6b5e2c47a">hid_report_buf</link>)&#32;/&#32;<emphasis role="keyword">sizeof</emphasis>(uint8_t));
00336 }
00337 
<anchor xml:id="_cusb_8c_source_1l00343"/><link linkend="_group___c_u_s_b___i_n_t_1gaa8a5a4bf8f2341314373f98f386d19ee">00343</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_group___c_u_s_b___i_n_t_1gaa8a5a4bf8f2341314373f98f386d19ee">hid_set_config</link>(usbd_device&#32;*dev,&#32;uint16_t&#32;wValue)
00344 {
00345 &#32;&#32;&#32;&#32;(void)wValue;
00346 &#32;&#32;&#32;&#32;(void)dev;
00347 
00348 &#32;&#32;&#32;&#32;usbd_ep_setup(dev,&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cac4a444971bf8e52ed478f89a9aea2f6d">ENDPOINT_HID_IN</link>,&#32;USB_ENDPOINT_ATTR_INTERRUPT,&#32;64,&#32;<link linkend="_group___c_u_s_b___i_n_t_1ga1bde282ff924bedfe37a99146df8b251">hid_report_callback</link>);
00349 &#32;&#32;&#32;&#32;usbd_ep_setup(dev,&#32;<link linkend="_group___c_u_s_b___c_f_g_1gga8d04a14f4c991504e1ee2df8b5e6f05cab6fa532c71274a0aa3a49297153fad04">ENDPOINT_HID_OUT</link>,&#32;USB_ENDPOINT_ATTR_INTERRUPT,&#32;64,&#32;<link linkend="_group___c_u_s_b___i_n_t_1ga1bde282ff924bedfe37a99146df8b251">hid_report_callback</link>);
00350 
00351 &#32;&#32;&#32;&#32;usbd_register_control_callback(
00352 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;dev,
00353 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;USB_REQ_TYPE_STANDARD&#32;|&#32;USB_REQ_TYPE_INTERFACE,
00354 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;USB_REQ_TYPE_TYPE&#32;|&#32;USB_REQ_TYPE_RECIPIENT,
00355 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___i_n_t_1ga29b474a495e8084ca9f797e1fcf75eb8">hid_control_request</link>);
00356 }
00357 
00358 
00359 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00360 <emphasis role="comment">//&#32;Static&#32;Function&#32;Declarations</emphasis>
00361 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00362 
00363 <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_group___c_u_s_b___i_n_t_1gac63b9392f307996959131c5a4e047fa4">cusb_clock_init</link>(<emphasis role="keywordtype">void</emphasis>);
00364 
00371 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00372 <emphasis role="comment">//&#32;Exported&#32;Function&#32;Definitions</emphasis>
00373 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
<anchor xml:id="_cusb_8c_source_1l00375"/><link linkend="_group___c_u_s_b___a_p_i_1ga371fec116e56a5c485a09d5dd8cd6c95">00375</link> <emphasis role="keyword">static</emphasis>&#32;usbd_device&#32;*<link linkend="_group___c_u_s_b___a_p_i_1ga371fec116e56a5c485a09d5dd8cd6c95">usbd_dev</link>;
00376 
<anchor xml:id="_cusb_8c_source_1l00378"/><link linkend="_group___c_u_s_b___a_p_i_1ga3f5c5e68ae07d989114524003357a6f7">00378</link> <emphasis role="keyword">static</emphasis>&#32;uint8_t&#32;<link linkend="_group___c_u_s_b___a_p_i_1ga3f5c5e68ae07d989114524003357a6f7">usbd_control_buffer</link>[128];
00379 
<anchor xml:id="_cusb_8c_source_1l00380"/><link linkend="_group___c_u_s_b___a_p_i_1gab4184b48312c430e82701746df0a97ca">00380</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_group___c_u_s_b___a_p_i_1gab4184b48312c430e82701746df0a97ca">cusb_init</link>(<emphasis role="keywordtype">void</emphasis>)
00381 {
00382 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Initialize&#32;clocks&#32;*/</emphasis>
00383 &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___i_n_t_1gac63b9392f307996959131c5a4e047fa4">cusb_clock_init</link>();
00384 
00385 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Reset&#32;USB&#32;*/</emphasis>
00386 &#32;&#32;&#32;&#32;SET_REG(USB_CNTR_REG,&#32;USB_CNTR_FRES);
00387 &#32;&#32;&#32;&#32;SET_REG(USB_CNTR_REG,&#32;0);
00388 &#32;&#32;&#32;&#32;SET_REG(USB_ISTR_REG,&#32;0);
00389 
00390 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Initialize&#32;USB&#32;*/</emphasis>
00391 &#32;&#32;&#32;&#32;<link linkend="_group___c_u_s_b___a_p_i_1ga371fec116e56a5c485a09d5dd8cd6c95">usbd_dev</link>&#32;=&#32;usbd_init(&amp;st_usbfs_v2_usb_driver,&#32;&amp;<link linkend="_group___c_u_s_b___c_f_g_1gaa168c0763ac7b2a074fba1297b1733b3">dev_desc</link>,&#32;&amp;<link linkend="_group___c_u_s_b___c_f_g_1ga82f3c163f54e2a1e4c606f965227af7c">cfg_desc</link>,&#32;<link linkend="_group___c_u_s_b___c_f_g_1ga2c37a11433a81e9f3e364d952a65ce5a">usb_strings</link>,&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_group___c_u_s_b___c_f_g_1ga2c37a11433a81e9f3e364d952a65ce5a">usb_strings</link>)&#32;/&#32;<emphasis role="keyword">sizeof</emphasis>(<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keywordtype">char</emphasis>&#32;*),&#32;<link linkend="_group___c_u_s_b___a_p_i_1ga3f5c5e68ae07d989114524003357a6f7">usbd_control_buffer</link>,&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_group___c_u_s_b___a_p_i_1ga3f5c5e68ae07d989114524003357a6f7">usbd_control_buffer</link>));
00392 
00393 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Register&#32;Configuration&#32;Callback&#32;for&#32;HID&#32;*/</emphasis>
00394 &#32;&#32;&#32;&#32;usbd_register_set_config_callback(<link linkend="_group___c_u_s_b___a_p_i_1ga371fec116e56a5c485a09d5dd8cd6c95">usbd_dev</link>,&#32;<link linkend="_group___c_u_s_b___i_n_t_1gaa8a5a4bf8f2341314373f98f386d19ee">hid_set_config</link>);
00395 }
00396 
<anchor xml:id="_cusb_8c_source_1l00397"/><link linkend="_group___c_u_s_b___a_p_i_1gac3db1642b64b360258b24bdd9496a390">00397</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_group___c_u_s_b___a_p_i_1gac3db1642b64b360258b24bdd9496a390">cusb_test_poll</link>(<emphasis role="keywordtype">void</emphasis>)
00398 {
00399 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(1)
00400 &#32;&#32;&#32;&#32;{
00401 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;usbd_poll(<link linkend="_group___c_u_s_b___a_p_i_1ga371fec116e56a5c485a09d5dd8cd6c95">usbd_dev</link>);
00402 &#32;&#32;&#32;&#32;}
00403 }
00404 
00411 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00412 <emphasis role="comment">//&#32;Static&#32;Function&#32;Definitions</emphasis>
00413 <emphasis role="comment">/*////////////////////////////////////////////////////////////////////////////*/</emphasis>
00414 
<anchor xml:id="_cusb_8c_source_1l00416"/><link linkend="_group___c_u_s_b___i_n_t_1gac63b9392f307996959131c5a4e047fa4">00416</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_group___c_u_s_b___i_n_t_1gac63b9392f307996959131c5a4e047fa4">cusb_clock_init</link>(<emphasis role="keywordtype">void</emphasis>)
00417 {
00418 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Set&#32;flash,&#32;16Mhz&#32;-&gt;&#32;0&#32;waitstates&#32;*/</emphasis>
00419 &#32;&#32;&#32;&#32;flash_set_ws(FLASH_ACR_LATENCY_0WS);
00420 
00421 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Turn&#32;on&#32;HSI16&#32;osc&#32;*/</emphasis>
00422 &#32;&#32;&#32;&#32;rcc_osc_on(RCC_HSI16);
00423 &#32;&#32;&#32;&#32;rcc_wait_for_osc_ready(RCC_HSI16);
00424 
00425 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Select&#32;CPU&#32;Clock&#32;*/</emphasis>
00426 &#32;&#32;&#32;&#32;rcc_set_sysclk_source(RCC_HSI16);
00427 
00428 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;HSI&#32;is&#32;now&#32;the&#32;wakeup&#32;clock&#32;*/</emphasis>
00429 &#32;&#32;&#32;&#32;RCC_CFGR&#32;|=&#32;RCC_CFGR_STOPWUCK_HSI16;
00430 
00431 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Set&#32;prescalers&#32;for&#32;AHB,&#32;APB1,&#32;APB2&#32;*/</emphasis>
00432 &#32;&#32;&#32;&#32;rcc_set_hpre(RCC_CFGR_HPRE_NODIV);&#32;&#32;&#32;<emphasis role="comment">/*&#32;AHB&#32;-&gt;&#32;16Mhz&#32;*/</emphasis>
00433 &#32;&#32;&#32;&#32;rcc_set_ppre1(RCC_CFGR_PPRE1_NODIV);&#32;<emphasis role="comment">/*&#32;APB1&#32;-&gt;16Mhz&#32;*/</emphasis>
00434 &#32;&#32;&#32;&#32;rcc_set_ppre2(RCC_CFGR_PPRE2_NODIV);&#32;<emphasis role="comment">/*&#32;APB2&#32;-&gt;16Mhz&#32;*/</emphasis>
00435 
00436 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Set&#32;Peripheral&#32;Clock&#32;Frequencies&#32;used&#32;*/</emphasis>
00437 &#32;&#32;&#32;&#32;rcc_ahb_frequency&#32;=&#32;16000000;
00438 &#32;&#32;&#32;&#32;rcc_apb1_frequency&#32;=&#32;16000000;
00439 &#32;&#32;&#32;&#32;rcc_apb2_frequency&#32;=&#32;16000000;
00440 
00441 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Enable&#32;the&#32;VREF&#32;for&#32;HSI48&#32;*/</emphasis>
00442 &#32;&#32;&#32;&#32;rcc_periph_clock_enable(RCC_SYSCFG);
00443 &#32;&#32;&#32;&#32;SYSCFG_CFGR3&#32;|=&#32;0x01;
00444 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(!(SYSCFG_CFGR3&#32;&amp;&#32;SYSCFG_CFGR3_VREFINT_RDYF))
00445 &#32;&#32;&#32;&#32;{
00446 &#32;&#32;&#32;&#32;}
00447 &#32;&#32;&#32;&#32;SYSCFG_CFGR3&#32;|=&#32;SYSCFG_CFGR3_ENREF_HSI48;
00448 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(!(SYSCFG_CFGR3&#32;&amp;&#32;SYSCFG_CFGR3_REF_HSI48_RDYF))
00449 &#32;&#32;&#32;&#32;{
00450 &#32;&#32;&#32;&#32;}
00451 
00452 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Enable&#32;HSI48&#32;*/</emphasis>
00453 &#32;&#32;&#32;&#32;rcc_osc_on(RCC_HSI48);
00454 &#32;&#32;&#32;&#32;rcc_wait_for_osc_ready(RCC_HSI48);
00455 
00456 &#32;&#32;&#32;&#32;rcc_periph_clock_enable(RCC_USB);
00457 &#32;&#32;&#32;&#32;rcc_periph_clock_enable(RCC_CRS);
00458 
00459 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;Select&#32;RC&#32;HSI48&#32;as&#32;usb&#32;clock&#32;*/</emphasis>
00460 &#32;&#32;&#32;&#32;rcc_set_hsi48_source_rc48();
00461 
00462 &#32;&#32;&#32;&#32;<emphasis role="comment">/*&#32;turn&#32;off&#32;MSI&#32;*/</emphasis>
00463 &#32;&#32;&#32;&#32;rcc_osc_off(RCC_MSI);
00464 }
00465 
00466 
</programlisting></section>
